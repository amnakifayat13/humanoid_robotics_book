openapi: 3.0.0
info:
  title: Docusaurus RAG Chatbot API
  version: 1.0.0
  description: API for integrating a RAG chatbot into a Docusaurus book.

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.your-domain.com
    description: Production server

paths:
  /ingest:
    post:
      summary: Ingest all book chapters into Qdrant
      operationId: ingestContent
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                docs_path:
                  type: string
                  description: Optional path to the Docusaurus /docs folder. Defaults to a configured path.
                  example: "/app/docusaurus/docs"
                clear_existing:
                  type: boolean
                  description: If true, clears existing collection before ingestion. Defaults to false.
                  example: false
      responses:
        '200':
          description: Ingestion process initiated successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Ingestion process started."
                  status:
                    type: string
                    example: "success"
        '500':
          description: Internal server error during ingestion.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /search:
    post:
      summary: Perform semantic search using Qdrant
      operationId: semanticSearch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search results retrieved successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/DocumentChunk'
        '400':
          description: Invalid search request.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error during search.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ask:
    post:
      summary: Combine search results + user query to generate an answer
      operationId: askChatbot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AskRequest'
      responses:
        '200':
          description: Answer generated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LLMResponse'
        '400':
          description: Invalid ask request.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error during answer generation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: The user's search query.
          example: "What is inverse kinematics?"
        limit:
          type: integer
          format: int32
          description: Maximum number of search results to return.
          default: 5
          minimum: 1
          example: 3
        # Additional filters could be added here for `selected_text_only_mode`
        # e.g., filter by chunk IDs or specific metadata fields if implemented.

    AskRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: The user's question for the chatbot.
          example: "How do I implement a custom Docusaurus plugin?"
        selected_text:
          type: string
          nullable: true
          description: Optional. If provided, the chatbot should restrict answers to this text.
          example: "Docusaurus plugins are Node.js modules that implement a lifecycle API."
        context_url:
          type: string
          nullable: true
          description: Optional. The URL of the Docusaurus page the user is on.
          example: "https://docusaurus.io/docs/guides/plugins"

    DocumentChunk:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the chunk.
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        content:
          type: string
          description: The cleaned text content of the chunk.
          example: "## Inverse Kinematics\nInverse kinematics (IK) is the analytical process of calculating the joint parameters that provide a desired position for the end-effector of a kinematic chain."
        metadata:
          type: object
          properties:
            source_file:
              type: string
              example: "/docs/kinematics.md"
            title:
              type: string
              example: "Kinematics Basics"
            section:
              type: string
              example: "Inverse Kinematics"
            page_url:
              type: string
              example: "https://your-book.com/docs/kinematics#inverse-kinematics"
            start_line:
              type: integer
              example: 15
            end_line:
              type: integer
              example: 20
        score:
          type: number
          format: float
          description: Relevance score from Qdrant search.
          example: 0.85

    LLMResponse:
      type: object
      properties:
        answer:
          type: string
          description: The generated text response from the LLM.
          example: "Inverse kinematics is the process of determining the joint angles of a robotic arm to reach a specific target position and orientation in space."
        source_chunks:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of the DocumentChunks used to generate the answer.
          example: ["a1b2c3d4-e5f6-7890-1234-567890abcdef", "f9e8d7c6-b5a4-3210-fedc-ba9876543210"]
        confidence:
          type: number
          format: float
          nullable: true
          description: Optional score indicating the LLM's confidence.
          example: 0.92
        error_message:
          type: string
          nullable: true
          description: Message if an error occurred or no relevant answer was found.
          example: "I could not find relevant information in the provided book content."

    ErrorResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: "An internal server error occurred."
        code:
          type: integer
          format: int32
          example: 500
